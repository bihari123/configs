#!/bin/bash

# Get list of existing sessions
sessions=($(tmux list-sessions -F '#S' 2>/dev/null))
current_session=$(tmux display-message -p '#S')

# Check if fzf is available for better scrolling experience
if command -v fzf &> /dev/null && [ ${#sessions[@]} -gt 0 ]; then
    # Build session list for fzf
    session_list=""
    for session in "${sessions[@]}"; do
        # Check if session is persistent
        is_persistent=$(tmux show-options -t "$session" -v @session-persistent 2>/dev/null || echo "true")
        type_label="[P]"
        if [ "$is_persistent" = "false" ]; then
            type_label="[T]"
        fi

        if [ "$session" = "$current_session" ]; then
            session_list+="→ Switch: $session $type_label (current)\n"
        else
            session_list+="→ Switch: $session $type_label\n"
        fi
    done
    session_list+="\n"
    for session in "${sessions[@]}"; do
        if [ "$session" != "$current_session" ]; then
            session_list+="✗ Delete: $session\n"
        fi
    done
    session_list+="\n+ Create new session\n"

    # Use fzf for selection
    selected=$(echo -e "$session_list" | fzf --height=100% --reverse --prompt="Select action: " --header="TMUX SESSION MANAGER" --no-info)

    if [ -z "$selected" ]; then
        exit 0
    fi

    # Handle new session
    if [[ "$selected" == "+ Create new session" ]]; then
        session_name=$(echo "" | fzf --print-query --prompt="Enter session name: " --header="CREATE NEW SESSION" | tail -1)
        if [ -n "$session_name" ]; then
            # Ask if session should be persistent or temporary
            session_type=$(echo -e "Persistent (saved)\nTemporary (not saved)" | fzf --height=40% --reverse --prompt="Session type: " --header="SELECT SESSION TYPE")

            tmux new-session -d -s "$session_name"

            # Set persistence flag
            if [[ "$session_type" == "Temporary (not saved)" ]]; then
                tmux set-option -t "$session_name" @session-persistent "false"
            else
                tmux set-option -t "$session_name" @session-persistent "true"
            fi

            tmux switch-client -t "$session_name"
        fi
        exit 0
    fi

    # Handle delete
    if [[ "$selected" =~ ^"✗ Delete: " ]]; then
        session_name=$(echo "$selected" | sed 's/^✗ Delete: //')
        # Confirm deletion
        confirm=$(echo -e "No\nYes" | fzf --height=40% --reverse --prompt="Delete '$session_name'? " --header="CONFIRM DELETION")
        if [ "$confirm" = "Yes" ]; then
            tmux kill-session -t "$session_name"
            # Reopen menu
            exec "$0"
        else
            # Reopen menu
            exec "$0"
        fi
        exit 0
    fi

    # Handle switch (remove prefix, type label, and (current) suffix)
    if [[ "$selected" =~ ^"→ Switch: " ]]; then
        session_name=$(echo "$selected" | sed 's/^→ Switch: //; s/ \[.\]//; s/ (current)$//')

        # If switching to current session with default numeric name, prompt to rename
        if [ "$session_name" = "$current_session" ] && [[ "$session_name" =~ ^[0-9]+$ ]]; then
            new_name=$(echo "" | fzf --print-query --prompt="Rename session '$session_name' to: " --header="RENAME CURRENT SESSION" | tail -1)
            if [ -n "$new_name" ] && [ "$new_name" != "$session_name" ]; then
                tmux rename-session -t "$session_name" "$new_name"
                # Save session immediately after rename
                ~/.tmux/plugins/tmux-resurrect/scripts/save.sh >/dev/null 2>&1 &
            fi
        else
            tmux switch-client -t "$session_name"
        fi
        exit 0
    fi

    exit 0
fi

# Fallback to scrollable numbered menu
clear
echo "╔════════════════════════════════════════════╗"
echo "║       TMUX SESSION SELECTOR               ║"
echo "╠════════════════════════════════════════════╣"

if [ ${#sessions[@]} -gt 0 ]; then
    echo "║ Existing Sessions: (scroll with ↑↓)      ║"
    echo "╠════════════════════════════════════════════╣"
    i=1
    for session in "${sessions[@]}"; do
        if [ "$session" = "$current_session" ]; then
            printf "║  %2d) %-34s * ║\n" "$i" "$session"
        else
            printf "║  %2d) %-36s ║\n" "$i" "$session"
        fi
        ((i++))
    done
    echo "╠════════════════════════════════════════════╣"
fi

echo "║  N) Create new session                     ║"
echo "║  D) Delete session                         ║"
echo "║  Q) Close this menu                        ║"
echo "╚════════════════════════════════════════════╝"
echo ""
read -p "Select option: " choice

# Handle quit
if [[ "$choice" =~ ^[Qq]$ ]]; then
    exit 0
fi

# Handle new session
if [[ "$choice" =~ ^[Nn]$ ]]; then
    read -p "Enter new session name: " session_name
    if [ -n "$session_name" ]; then
        read -p "Persistent (P) or Temporary (T)? [P/t]: " session_type

        tmux new-session -d -s "$session_name"

        # Set persistence flag (default to persistent)
        if [[ "$session_type" =~ ^[Tt]$ ]]; then
            tmux set-option -t "$session_name" @session-persistent "false"
            echo "Created temporary session (not saved)"
        else
            tmux set-option -t "$session_name" @session-persistent "true"
            echo "Created persistent session (will be saved)"
        fi
        sleep 1

        tmux switch-client -t "$session_name"
    fi
    exit 0
fi

# Handle delete session
if [[ "$choice" =~ ^[Dd]$ ]]; then
    if [ ${#sessions[@]} -eq 0 ]; then
        echo "No sessions to delete."
        sleep 1
        exec "$0"
    fi

    echo ""
    read -p "Enter session number to delete: " del_choice

    if [[ "$del_choice" =~ ^[0-9]+$ ]] && [ "$del_choice" -ge 1 ] && [ "$del_choice" -le "${#sessions[@]}" ]; then
        session_to_delete="${sessions[$((del_choice-1))]}"

        # Don't allow deleting current session
        if [ "$session_to_delete" = "$current_session" ]; then
            echo "Cannot delete current session. Switch to another session first."
            sleep 2
            exec "$0"
        fi

        read -p "Delete session '$session_to_delete'? (y/N): " confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
            tmux kill-session -t "$session_to_delete"
            echo "Session '$session_to_delete' deleted."
            sleep 1
        fi
    fi
    exec "$0"
fi

# Handle session selection by number
if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#sessions[@]}" ]; then
    selected_session="${sessions[$((choice-1))]}"

    # If selecting current session with default numeric name, prompt to rename
    if [ "$selected_session" = "$current_session" ] && [[ "$selected_session" =~ ^[0-9]+$ ]]; then
        read -p "Rename session '$selected_session' to: " new_name
        if [ -n "$new_name" ] && [ "$new_name" != "$selected_session" ]; then
            tmux rename-session -t "$selected_session" "$new_name"
            # Save session immediately after rename
            ~/.tmux/plugins/tmux-resurrect/scripts/save.sh >/dev/null 2>&1 &
        fi
    else
        tmux switch-client -t "$selected_session"
    fi
    exit 0
fi

echo "Invalid selection."
sleep 1
