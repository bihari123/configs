#!/bin/bash

# Ensure we have the full PATH (tmux popup uses limited environment)
export PATH="$HOME/.local/bin:$HOME/bin:$HOME/go/bin:$HOME/.cargo/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

# Get list of existing sessions
sessions=($(tmux list-sessions -F '#S' 2>/dev/null))
current_session=$(tmux display-message -p '#S')

# Check if sesh and fzf are available
if command -v sesh &> /dev/null && command -v fzf &> /dev/null; then
    # Build session list using sesh for discovery
    session_list=""

    # Get sesh suggestions (tmux sessions + zoxide directories)
    while IFS= read -r item; do
        # Check if this is an existing tmux session
        is_tmux_session=false
        for session in "${sessions[@]}"; do
            if [ "$item" = "$session" ]; then
                is_tmux_session=true
                break
            fi
        done

        if [ "$is_tmux_session" = true ]; then
            # Check if session is persistent
            is_persistent=$(tmux show-options -t "$item" -v @session-persistent 2>/dev/null || echo "true")
            type_label="[P]"
            if [ "$is_persistent" = "false" ]; then
                type_label="[T]"
            fi

            if [ "$item" = "$current_session" ]; then
                session_list+="â†’ Switch: $item $type_label (current)\n"
            else
                session_list+="â†’ Switch: $item $type_label\n"
            fi
        else
            # This is a zoxide directory or other sesh suggestion
            session_list+="ğŸ“ New from: $item\n"
        fi
    done < <(sesh list -t -z 2>/dev/null)

    # Add delete options for existing sessions
    if [ ${#sessions[@]} -gt 0 ]; then
        session_list+="\n"
        for session in "${sessions[@]}"; do
            if [ "$session" != "$current_session" ]; then
                session_list+="âœ— Delete: $session\n"
            fi
        done
        session_list+="\nâœ— Delete ALL other sessions (keep current)\n"
    fi

    # Add creation options
    session_list+="\n+ Create new session (persistent)\n"
    session_list+="+ Create temporary session\n"
    session_list+="âŸ³ Create persistent and delete current\n"
    session_list+="âŸ³ Create temporary and delete current\n"

    # Use fzf for selection
    selected=$(echo -e "$session_list" | fzf --height=100% --reverse --prompt="Select action: " --header="TMUX SESSION MANAGER (powered by sesh)" --no-info)

    if [ -z "$selected" ]; then
        exit 0
    fi

    # Handle new session from directory (sesh zoxide/directory suggestions)
    if [[ "$selected" =~ ^"ğŸ“ New from: " ]]; then
        dir_path=$(echo "$selected" | sed 's/^ğŸ“ New from: //')
        # Create session name from directory name
        session_name=$(basename "$dir_path" | tr . _)

        # Check if session already exists
        if tmux has-session -t "$session_name" 2>/dev/null; then
            tmux switch-client -t "$session_name"
        else
            # Create new persistent session and cd to directory
            tmux new-session -d -s "$session_name" -c "$dir_path"
            tmux set-option -t "$session_name" @session-persistent "true"
            tmux switch-client -t "$session_name"
        fi
        exit 0
    fi

    # Handle new persistent session
    if [[ "$selected" == "+ Create new session (persistent)" ]]; then
        session_name=$(echo "" | fzf --print-query --prompt="Enter session name: " --header="CREATE PERSISTENT SESSION" | tail -1)
        if [ -n "$session_name" ]; then
            tmux new-session -d -s "$session_name"
            tmux set-option -t "$session_name" @session-persistent "true"
            tmux switch-client -t "$session_name"
        fi
        exit 0
    fi

    # Handle new temporary session
    if [[ "$selected" == "+ Create temporary session" ]]; then
        tmux new-session -d
        new_session=$(tmux display-message -p '#S')
        tmux set-option -t "$new_session" @session-persistent "false"
        tmux switch-client -t "$new_session"
        exit 0
    fi

    # Handle create persistent and delete current
    if [[ "$selected" == "âŸ³ Create persistent and delete current" ]]; then
        session_name=$(echo "" | fzf --print-query --prompt="Enter session name: " --header="CREATE PERSISTENT SESSION" | tail -1)
        if [ -n "$session_name" ]; then
            old_session="$current_session"
            tmux new-session -d -s "$session_name"
            tmux set-option -t "$session_name" @session-persistent "true"
            tmux switch-client -t "$session_name"
            tmux kill-session -t "$old_session"
        fi
        exit 0
    fi

    # Handle create temporary and delete current
    if [[ "$selected" == "âŸ³ Create temporary and delete current" ]]; then
        old_session="$current_session"
        tmux new-session -d
        new_session=$(tmux display-message -p '#S')
        tmux set-option -t "$new_session" @session-persistent "false"
        tmux switch-client -t "$new_session"
        tmux kill-session -t "$old_session"
        exit 0
    fi

    # Handle delete all other sessions
    if [[ "$selected" =~ ^"âœ— Delete ALL other sessions" ]]; then
        # Confirm deletion
        current=$(tmux display-message -p '#S')
        other_sessions=()
        while IFS= read -r session; do
            if [ "$session" != "$current" ]; then
                other_sessions+=("$session")
            fi
        done < <(tmux list-sessions -F '#{session_name}')

        if [ ${#other_sessions[@]} -eq 0 ]; then
            echo "No other sessions to delete."
            sleep 1
            exec "$0"
        fi
        confirm=$(echo -e "No\nYes" | fzf --height=40% --reverse --prompt="Delete ${#other_sessions[@]} other session(s)? " --header="CONFIRM DELETE ALL")
        if [ "$confirm" = "Yes" ]; then
            for sess in "${other_sessions[@]}"; do
                tmux kill-session -t "$sess"
            done
            # Reopen menu
            exec "$0"
        else
            # Reopen menu
            exec "$0"
        fi
        exit 0
    fi

    # Handle delete
    if [[ "$selected" =~ ^"âœ— Delete: " ]]; then
        session_name=$(echo "$selected" | sed 's/^âœ— Delete: //')
        # Confirm deletion
        confirm=$(echo -e "No\nYes" | fzf --height=40% --reverse --prompt="Delete '$session_name'? " --header="CONFIRM DELETION")
        if [ "$confirm" = "Yes" ]; then
            tmux kill-session -t "$session_name"
            # Reopen menu
            exec "$0"
        else
            # Reopen menu
            exec "$0"
        fi
        exit 0
    fi

    # Handle switch (remove prefix, type label, and (current) suffix)
    if [[ "$selected" =~ ^"â†’ Switch: " ]]; then
        session_name=$(echo "$selected" | sed 's/^â†’ Switch: //; s/ \[.\]//; s/ (current)$//')

        # If switching to current session with default numeric name, prompt to rename
        if [ "$session_name" = "$current_session" ] && [[ "$session_name" =~ ^[0-9]+$ ]]; then
            new_name=$(echo "" | fzf --print-query --prompt="Rename session '$session_name' to: " --header="RENAME CURRENT SESSION" | tail -1)
            if [ -n "$new_name" ] && [ "$new_name" != "$session_name" ]; then
                tmux rename-session -t "$session_name" "$new_name"
                # Save session immediately after rename
                ~/.tmux/plugins/tmux-resurrect/scripts/save.sh >/dev/null 2>&1 &
            fi
        else
            tmux switch-client -t "$session_name"
        fi
        exit 0
    fi

    exit 0
fi

# Fallback to scrollable numbered menu
clear
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘       TMUX SESSION SELECTOR               â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

if [ ${#sessions[@]} -gt 0 ]; then
    echo "â•‘ Existing Sessions: (scroll with â†‘â†“)      â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    i=1
    for session in "${sessions[@]}"; do
        if [ "$session" = "$current_session" ]; then
            printf "â•‘  %2d) %-34s * â•‘\n" "$i" "$session"
        else
            printf "â•‘  %2d) %-36s â•‘\n" "$i" "$session"
        fi
        ((i++))
    done
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
fi

echo "â•‘  N) Create new session (persistent)        â•‘"
echo "â•‘  T) Create temporary session               â•‘"
echo "â•‘  P) Create persistent & delete current     â•‘"
echo "â•‘  X) Create temporary & delete current      â•‘"
echo "â•‘  D) Delete session                         â•‘"
echo "â•‘  K) Kill all other sessions (keep current) â•‘"
echo "â•‘  Q) Close this menu                        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
read -p "Select option: " choice

# Handle quit
if [[ "$choice" =~ ^[Qq]$ ]]; then
    exit 0
fi

# Handle new persistent session
if [[ "$choice" =~ ^[Nn]$ ]]; then
    read -p "Enter session name: " session_name
    if [ -n "$session_name" ]; then
        tmux new-session -d -s "$session_name"
        tmux set-option -t "$session_name" @session-persistent "true"
        echo "Created persistent session: $session_name (will be saved)"
        sleep 1
        tmux switch-client -t "$session_name"
    fi
    exit 0
fi

# Handle new temporary session
if [[ "$choice" =~ ^[Tt]$ ]]; then
    tmux new-session -d
    new_session=$(tmux display-message -p '#S')
    tmux set-option -t "$new_session" @session-persistent "false"
    echo "Created temporary session: $new_session (not saved)"
    sleep 1
    tmux switch-client -t "$new_session"
    exit 0
fi

# Handle create persistent and delete current
if [[ "$choice" =~ ^[Pp]$ ]]; then
    read -p "Enter session name: " session_name
    if [ -n "$session_name" ]; then
        old_session="$current_session"
        tmux new-session -d -s "$session_name"
        tmux set-option -t "$session_name" @session-persistent "true"
        echo "Created persistent session: $session_name (will be saved)"
        echo "Switching and deleting old session: $old_session"
        sleep 1
        tmux switch-client -t "$session_name"
        tmux kill-session -t "$old_session"
    fi
    exit 0
fi

# Handle create temporary and delete current
if [[ "$choice" =~ ^[Xx]$ ]]; then
    old_session="$current_session"
    tmux new-session -d
    new_session=$(tmux display-message -p '#S')
    tmux set-option -t "$new_session" @session-persistent "false"
    echo "Created temporary session: $new_session (not saved)"
    echo "Switching and deleting old session: $old_session"
    sleep 1
    tmux switch-client -t "$new_session"
    tmux kill-session -t "$old_session"
    exit 0
fi

# Handle delete session
if [[ "$choice" =~ ^[Dd]$ ]]; then
    if [ ${#sessions[@]} -eq 0 ]; then
        echo "No sessions to delete."
        sleep 1
        exec "$0"
    fi

    echo ""
    read -p "Enter session number to delete: " del_choice

    if [[ "$del_choice" =~ ^[0-9]+$ ]] && [ "$del_choice" -ge 1 ] && [ "$del_choice" -le "${#sessions[@]}" ]; then
        session_to_delete="${sessions[$((del_choice-1))]}"

        # Don't allow deleting current session
        if [ "$session_to_delete" = "$current_session" ]; then
            echo "Cannot delete current session. Switch to another session first."
            sleep 2
            exec "$0"
        fi

        read -p "Delete session '$session_to_delete'? (y/N): " confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
            tmux kill-session -t "$session_to_delete"
            echo "Session '$session_to_delete' deleted."
            sleep 1
        fi
    fi
    exec "$0"
fi

# Handle kill all other sessions
if [[ "$choice" =~ ^[Kk]$ ]]; then
    current=$(tmux display-message -p '#S')
    other_sessions=()
    while IFS= read -r session; do
        if [ "$session" != "$current" ]; then
            other_sessions+=("$session")
        fi
    done < <(tmux list-sessions -F '#{session_name}')

    if [ ${#other_sessions[@]} -eq 0 ]; then
        echo "No other sessions to delete."
        sleep 2
        exec "$0"
    fi

    echo ""
    echo "Other sessions:"
    for sess in "${other_sessions[@]}"; do
        echo "  - $sess"
    done
    echo ""
    read -p "Delete all ${#other_sessions[@]} other session(s)? (y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        for sess in "${other_sessions[@]}"; do
            tmux kill-session -t "$sess"
        done
        echo "All other sessions deleted."
        sleep 1
    fi
    exec "$0"
fi

# Handle session selection by number
if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#sessions[@]}" ]; then
    selected_session="${sessions[$((choice-1))]}"

    # If selecting current session with default numeric name, prompt to rename
    if [ "$selected_session" = "$current_session" ] && [[ "$selected_session" =~ ^[0-9]+$ ]]; then
        read -p "Rename session '$selected_session' to: " new_name
        if [ -n "$new_name" ] && [ "$new_name" != "$selected_session" ]; then
            tmux rename-session -t "$selected_session" "$new_name"
            # Save session immediately after rename
            ~/.tmux/plugins/tmux-resurrect/scripts/save.sh >/dev/null 2>&1 &
        fi
    else
        tmux switch-client -t "$selected_session"
    fi
    exit 0
fi

echo "Invalid selection."
sleep 1
