#!/bin/bash

# Get list of existing sessions
sessions=($(tmux list-sessions -F '#S' 2>/dev/null))
current_session=$(tmux display-message -p '#S')

# Check if fzf is available for better scrolling experience
if command -v fzf &> /dev/null && [ ${#sessions[@]} -gt 0 ]; then
    # Build session list for fzf
    session_list=""
    for session in "${sessions[@]}"; do
        if [ "$session" = "$current_session" ]; then
            session_list+="* $session (current)\n"
        else
            session_list+="  $session\n"
        fi
    done
    session_list+="+ Create new session\n"

    # Use fzf for selection
    selected=$(echo -e "$session_list" | fzf --height=100% --reverse --prompt="Select session: " --header="TMUX SESSION SELECTOR" --no-info)

    if [ -z "$selected" ]; then
        exit 0
    fi

    # Handle new session
    if [[ "$selected" == "+ Create new session" ]]; then
        session_name=$(echo "" | fzf --print-query --prompt="Enter session name: " --header="CREATE NEW SESSION" | tail -1)
        if [ -n "$session_name" ]; then
            tmux new-session -d -s "$session_name"
            tmux switch-client -t "$session_name"
        fi
        exit 0
    fi

    # Extract session name (remove leading * or spaces and (current) suffix)
    session_name=$(echo "$selected" | sed 's/^[* ]*//; s/ (current)$//')
    tmux switch-client -t "$session_name"
    exit 0
fi

# Fallback to scrollable numbered menu
clear
echo "╔════════════════════════════════════════════╗"
echo "║       TMUX SESSION SELECTOR               ║"
echo "╠════════════════════════════════════════════╣"

if [ ${#sessions[@]} -gt 0 ]; then
    echo "║ Existing Sessions: (scroll with ↑↓)      ║"
    echo "╠════════════════════════════════════════════╣"
    i=1
    for session in "${sessions[@]}"; do
        if [ "$session" = "$current_session" ]; then
            printf "║  %2d) %-34s * ║\n" "$i" "$session"
        else
            printf "║  %2d) %-36s ║\n" "$i" "$session"
        fi
        ((i++))
    done
    echo "╠════════════════════════════════════════════╣"
fi

echo "║  N) Create new session                     ║"
echo "║  Q) Close this menu                        ║"
echo "╚════════════════════════════════════════════╝"
echo ""
read -p "Select option: " choice

# Handle quit
if [[ "$choice" =~ ^[Qq]$ ]]; then
    exit 0
fi

# Handle new session
if [[ "$choice" =~ ^[Nn]$ ]]; then
    read -p "Enter new session name: " session_name
    if [ -n "$session_name" ]; then
        tmux new-session -d -s "$session_name"
        tmux switch-client -t "$session_name"
    fi
    exit 0
fi

# Handle session selection by number
if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#sessions[@]}" ]; then
    selected_session="${sessions[$((choice-1))]}"
    tmux switch-client -t "$selected_session"
    exit 0
fi

echo "Invalid selection."
sleep 1
