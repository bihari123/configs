set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-logging'

# Persistent sessions configuration
set -g @continuum-restore 'on'  # Auto-restore sessions on tmux start
set -g @continuum-save-interval '1'  # Auto-save every 1 minute
set -g @resurrect-capture-pane-contents 'on'  # Save pane contents
set -g @resurrect-save-shell-history 'on'  # Save shell command history

# Restore strategies for specific programs
set -g @resurrect-strategy-nvim 'session'  # Save nvim sessions
set -g @resurrect-strategy-vim 'session'   # Save vim sessions

# Programs to restore automatically (will restart with same command)
set -g @resurrect-processes 'ssh psql mysql sqlite3 "~npm start" "~npm run dev" "~python" "~node" "~go run" "~cargo run"'

# Increase scrollback buffer for better history capture
set-option -g history-limit 50000  # Store 50k lines of scrollback per pane

# Hook to filter temporary sessions after each save
set -g @resurrect-hook-post-save-all 'bash ~/configs/bin/tmux-resurrect-filter-post'

# Hooks for auto-displaying previous pane content on restore
set -g @resurrect-hook-pre-restore-all 'touch ~/.tmux/resurrect/.restore-in-progress && (sleep 60 && rm -f ~/.tmux/resurrect/.restore-in-progress ~/.tmux/resurrect/.pane-content-shown-* 2>/dev/null &)'

# Logging configuration
set -g @logging-path "$HOME/.tmux/logs"
set -g @logging-filename "#{session_name}-#{window_index}-#{pane_index}-%Y%m%d-%H%M%S.log"
set -g @screen-capture-path "$HOME/.tmux/logs"
set -g @save-complete-history-path "$HOME/.tmux/logs"

# Save on meaningful events (immediate saves when structure changes)
# Only trigger saves from persistent sessions (filtering happens in post-save hook)
set-hook -g after-new-window 'run-shell "~/configs/bin/tmux-save-persistent"'
set-hook -g after-split-window 'run-shell "~/configs/bin/tmux-save-persistent"'
set-hook -g pane-exited 'run-shell "~/configs/bin/tmux-save-persistent"'
set-hook -g window-renamed 'run-shell "~/configs/bin/tmux-save-persistent"'
set-hook -g session-renamed 'run-shell "~/configs/bin/tmux-save-persistent"'

# ============ Mouse Support (must be early) ============
set -g mouse on
set -ga terminal-features "*:mouse"

# ============ Zellij-like Keybindings ============
# Prefix key (similar to Zellij's Ctrl+g for modes)
unbind C-b
set -g prefix C-g
bind C-g send-prefix

# Pane Management (Zellij Pane Mode - Ctrl+p)
bind -n M-n split-window -h -c "#{pane_current_path}"  # Alt+n: New pane (right)
bind -n M-d split-window -v -c "#{pane_current_path}"  # Alt+d: New pane (down)

# Pane Navigation (Vim-like, similar to Zellij)
bind -n M-h select-pane -L  # Alt+h: Move left
bind -n M-l select-pane -R  # Alt+l: Move right
bind -n M-j select-pane -D  # Alt+j: Move down
bind -n M-k select-pane -U  # Alt+k: Move up
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Down select-pane -D
bind -n M-Up select-pane -U

# Pane actions
bind -n M-x kill-pane  # Alt+x: Close pane
bind -n M-f resize-pane -Z  # Alt+f: Toggle fullscreen (zoom)
bind -n M-r command-prompt -p "Pane title:" "select-pane -T '%%'"  # Alt+r: Rename pane
bind -n M-o next-layout  # Alt+o: Cycle through layouts (horizontal, vertical, tiled, etc.)

# Tab/Window Management (Zellij Tab Mode)
bind -n M-t new-window -c "#{pane_current_path}"  # Alt+t: New tab/window
bind -n M-w kill-window  # Alt+w: Close tab/window
bind -n M-[ previous-window  # Alt+[: Previous tab
bind -n M-] next-window  # Alt+]: Next tab
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Resize Mode (Zellij Resize Mode - prefix + r)
bind r switch-client -T resize_mode
bind -T resize_mode h resize-pane -L 5
bind -T resize_mode j resize-pane -D 5
bind -T resize_mode k resize-pane -U 5
bind -T resize_mode l resize-pane -R 5
bind -T resize_mode Left resize-pane -L 5
bind -T resize_mode Down resize-pane -D 5
bind -T resize_mode Up resize-pane -U 5
bind -T resize_mode Right resize-pane -R 5
bind -T resize_mode Escape switch-client -T prefix
bind -T resize_mode Enter switch-client -T prefix

# Session Management
bind -n M-s display-popup -E -w 80% -h 80% "~/configs/bin/tmux-session-menu"  # Alt+s: Session selector
bind -n M-S run-shell "~/configs/bin/tmux-save-persistent" \; display-message "Session saved!"  # Alt+Shift+s: Manual save
bind -n M-K confirm-before -p "Kill all other sessions? (y/n)" "run-shell \"tmux list-sessions -F '#{session_name}' | grep -v '^$(tmux display-message -p '#S')\$' | xargs -r -I {} tmux kill-session -t {}\""  # Alt+Shift+k: Kill all other sessions

# Logging (capturing pane output)
bind -n M-L run-shell "~/.tmux/plugins/tmux-logging/scripts/toggle_logging.sh" \; display-message "Logging toggled"  # Alt+Shift+l: Toggle logging
bind -n M-H run-shell "~/.tmux/plugins/tmux-logging/scripts/save_complete_history.sh" \; display-message "Complete history saved to ~/.tmux/logs/"  # Alt+Shift+h: Save complete history
bind -n M-P run-shell "~/.tmux/plugins/tmux-logging/scripts/screen_capture.sh" \; display-message "Screen captured to ~/.tmux/logs/"  # Alt+Shift+p: Screen capture (visible content)

# View saved pane contents from last resurrect save
bind -n M-V run-shell "~/configs/bin/tmux-view-saved-pane"  # Alt+Shift+v: View saved pane scrollback

# Help menu - Show all keyboard shortcuts
bind -n M-? display-popup -E -w 80% -h 80% "bash -c '
cat << \"EOF\"

╔════════════════════════════════════════════════════════════════════════╗
║                    TMUX KEYBOARD SHORTCUTS (Zellij-like)               ║
╠════════════════════════════════════════════════════════════════════════╣
║ GENERAL                                                                ║
║   Ctrl+g           Prefix key (use before other commands)              ║
║   Alt+?            Show this help menu                                 ║
║                                                                        ║
║ PANE MANAGEMENT                                                        ║
║   Alt+n            New pane (split right)                              ║
║   Alt+d            New pane (split down)                               ║
║   Alt+x            Close current pane                                  ║
║   Alt+f            Toggle fullscreen/zoom                              ║
║   Alt+o            Cycle through layouts                               ║
║   Alt+r            Rename current pane                                 ║
║                                                                        ║
║ PANE NAVIGATION                                                        ║
║   Alt+h/←          Move to left pane                                   ║
║   Alt+j/↓          Move to bottom pane                                 ║
║   Alt+k/↑          Move to top pane                                    ║
║   Alt+l/→          Move to right pane                                  ║
║                                                                        ║
║ RESIZE MODE                                                            ║
║   Ctrl+g r         Enter resize mode                                   ║
║   h/j/k/l          Resize pane (in resize mode)                        ║
║   Esc/Enter        Exit resize mode                                    ║
║                                                                        ║
║ TAB/WINDOW MANAGEMENT                                                  ║
║   Alt+t            New tab/window                                      ║
║   Alt+w            Close current tab/window                            ║
║   Alt+[            Previous tab                                        ║
║   Alt+]            Next tab                                            ║
║   Alt+1-9          Switch to tab number 1-9                            ║
║                                                                        ║
║ SESSION MANAGEMENT                                                     ║
║   Alt+s            Session selector                                    ║
║   Alt+Shift+s      Manual save session                                 ║
║   Alt+Shift+k      Kill all other sessions (keep current)              ║
║   Ctrl+g d         Detach from session                                 ║
║                                                                        ║
║ LOGGING (Output Capture)                                               ║
║   Alt+Shift+l      Toggle continuous logging for current pane          ║
║   Alt+Shift+h      Save complete scrollback history to file            ║
║   Alt+Shift+p      Capture visible screen content to file              ║
║   Alt+Shift+v      View saved pane contents from last session save     ║
║                                                                        ║
║ LEGACY BINDINGS (with prefix Ctrl+g)                                   ║
║   Ctrl+g \"         Split vertical                                      ║
║   Ctrl+g %         Split horizontal                                    ║
║   Ctrl+g c         New window                                          ║
║   Ctrl+g B         Toggle pane border position (top/bottom)            ║
╚════════════════════════════════════════════════════════════════════════╝

Press any key to close...
EOF
read -n 1 -s
'"

# Legacy bindings compatibility
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
# Bottom status line (two lines)
set -g status-position bottom
set -g status 2
set -g status-style 'bg=#000000,fg=colour137'

# First status line: Session (left), tabs/windows (center), date/time (right)
# IMPORTANT: Use status-format[0] with proper range= for mouse support
set -g status-format[0] '#[align=left range=left #{status-left-style}]#[push-default]#{T;=/#{status-left-length}:status-left}#[pop-default]#[norange default]#[list=on align=#{status-justify}]#[list=left-marker]<#[list=right-marker]>#[list=on]#{W:#[range=window|#{window_index} #{E:window-status-style}#{?#{&&:#{window_last_flag},#{!=:#{E:window-status-last-style},default}}, #{E:window-status-last-style},}#{?#{&&:#{window_bell_flag},#{!=:#{E:window-status-bell-style},default}}, #{E:window-status-bell-style},#{?#{&&:#{||:#{window_activity_flag},#{window_silence_flag}},#{!=:#{E:window-status-activity-style},default}}, #{E:window-status-activity-style},}}]#[push-default]#{T:window-status-format}#[pop-default]#[norange default]#{?window_end_flag,,#{window-status-separator}},#[range=window|#{window_index} list=focus #{?#{!=:#{E:window-status-current-style},default},#{E:window-status-current-style},#{E:window-status-style}}#{?#{&&:#{window_last_flag},#{!=:#{E:window-status-last-style},default}}, #{E:window-status-last-style},}#{?#{&&:#{window_bell_flag},#{!=:#{E:window-status-bell-style},default}}, #{E:window-status-bell-style},#{?#{&&:#{||:#{window_activity_flag},#{window_silence_flag}},#{!=:#{E:window-status-activity-style},default}}, #{E:window-status-activity-style},}}]#[push-default]#{T:window-status-current-format}#[pop-default]#[norange list=on default]#{?window_end_flag,,#{window-status-separator}}}#[nolist align=right range=right #{status-right-style}]#[push-default]#{T;=/#{status-right-length}:status-right}#[pop-default]#[norange default]'
set -g status-left-length 40
set -g status-left '#[fg=colour233,bg=colour241,bold] #S #[fg=colour241,bg=#000000,nobold] '
set -g status-right '#[fg=colour233,bg=colour241,bold] %d/%m #[fg=colour233,bg=colour245,bold] %H:%M:%S '
set -g status-justify centre
set -g window-status-current-format '#[fg=colour233,bg=colour148,bold] #I:#W#{?window_zoomed_flag, ⛶,} #[fg=colour148,bg=#000000,nobold]'
set -g window-status-format '#[fg=white,bg=#000000] #I:#W#{?window_zoomed_flag, ⛶,} '

# Second status line: Keyboard shortcuts
set -g status-format[1] '#[align=centre fg=colour244,bg=#000000] Alt+?:Help #[fg=colour148,bg=#000000] Alt+n:Pane #[fg=colour244,bg=#000000] Alt+t:Tab #[fg=colour148,bg=#000000] Alt+hjkl:Nav #[fg=colour244,bg=#000000] Alt+o:Layout #[fg=colour148,bg=#000000] Alt+x:Close #[fg=colour244,bg=#000000] Alt+f:Zoom #[fg=colour148,bg=#000000] Alt+s:Session #[fg=colour244,bg=#000000] Alt+Shift+l:Log'

# Pane borders (heavy/double line style)
set -g pane-border-status top
set -g pane-border-style fg=red
set -g pane-active-border-style fg=colour148,bold
set -g pane-border-lines heavy
set -g pane-border-format "#[fg=#000000,bg=colour148,bold] #{?pane_active,●,○} #P #[fg=colour148,bg=colour240,nobold]#[#{?pane_active,fg=white,fg=colour250},bg=colour240,bold] #{pane_title} #[fg=colour240,bg=colour238]#[fg=colour244,bg=colour238] [#{pane_current_command}] #[fg=colour238,bg=colour241]#[fg=colour233,bg=colour241,bold] %d/%m %H:%M #[fg=colour241,bg=#000000]"

# Different theme for inactive panes
set -g window-style 'fg=colour117,bg=colour237'
set -g window-active-style 'fg=colour250,bg=#000000'

# Key binding to toggle pane border position
bind-key B if -F '#{s/bottom//:pane-border-status}' 'set pane-border-status top' 'set pane-border-status bottom'

# Message styling
set -g message-style 'fg=colour166,bg=#000000,bold'

run '~/.tmux/plugins/tpm/tpm'

# Mouse support - set AFTER plugins to override
set -g mouse on
set -ga terminal-features "*:mouse"
set -s set-clipboard on

# Fix mouse click on windows in status bar (with status 2)
bind-key -n MouseDown1StatusDefault select-window -t =
bind-key -n DoubleClick1StatusDefault select-window -t =
